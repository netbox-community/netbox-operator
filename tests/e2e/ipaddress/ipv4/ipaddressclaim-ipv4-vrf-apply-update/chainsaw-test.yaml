---
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: ipaddressclaim-ipv4-vrf-apply-update
  annotations:
    description: Tests if creation and update is successful with VRF
spec:
  steps:
    - name: Apply CR
      try:
        - apply:
            file: netbox_v1_ipaddressclaim.yaml
    - name: Check CR spec and status
      try:
        - assert:
            resource:
              apiVersion: netbox.dev/v1
              kind: IpAddressClaim
              metadata:
                name: ipaddressclaim-ipv4-vrf-apply-update
              spec:
                tenant: "MY_TENANT"
                vrf: "MY_VRF"
                description: "some description"
                comments: "your comments"
                preserveInNetbox: false
                parentPrefix: "4.0.0.0/24"
              status:
                (conditions[?type == 'Ready']):
                  - status: 'True'
                ipAddress: 4.0.0.1/32
                ipAddressDotDecimal: 4.0.0.1
                ipAddressName: ipaddressclaim-ipv4-vrf-apply-update
        - assert:
            resource:
              apiVersion: netbox.dev/v1
              kind: IpAddress
              metadata:
                name: ipaddressclaim-ipv4-vrf-apply-update
                finalizers:
                  - ipaddress.netbox.dev/finalizer
                ownerReferences:
                  - apiVersion: netbox.dev/v1
                    blockOwnerDeletion: true
                    controller: true
                    kind: IpAddressClaim
                    name: ipaddressclaim-ipv4-vrf-apply-update
              spec:
                comments: your comments
                description: some description
                ipAddress: 4.0.0.1/32
                tenant: MY_TENANT
                vrf: MY_VRF
              status:
                (conditions[?type == 'Ready']):
                  - status: 'True'
    - name: Update CR
      try:
        - apply:
            file: netbox_v1_ipaddressclaim-update.yaml
    - name: Check CR spec and status
      try:
        - assert:
            resource:
              apiVersion: netbox.dev/v1
              kind: IpAddressClaim
              metadata:
                name: ipaddressclaim-ipv4-vrf-apply-update
              spec:
                tenant: "MY_TENANT"
                vrf: "MY_VRF"
                description: "new description"
                comments: "new comments"
                preserveInNetbox: false
                parentPrefix: "4.0.0.0/24"
              status:
                (conditions[?type == 'Ready']):
                  - status: 'True'
                ipAddress: 4.0.0.1/32
                ipAddressDotDecimal: 4.0.0.1
                ipAddressName: ipaddressclaim-ipv4-vrf-apply-update
        - assert:
            resource:
              apiVersion: netbox.dev/v1
              kind: IpAddress
              metadata:
                name: ipaddressclaim-ipv4-vrf-apply-update
                finalizers:
                  - ipaddress.netbox.dev/finalizer
                ownerReferences:
                  - apiVersion: netbox.dev/v1
                    blockOwnerDeletion: true
                    controller: true
                    kind: IpAddressClaim
                    name: ipaddressclaim-ipv4-vrf-apply-update
              spec:
                comments: new comments
                description: new description
                ipAddress: 4.0.0.1/32
                tenant: MY_TENANT
                vrf: MY_VRF
              status:
                (conditions[?type == 'Ready']):
                  - status: 'True'
    - name: Cleanup events
      description: Events cleanup required to fix issues with failing tests that assert the wrong Error resource
      cleanup:
        - script:
            content: |-
              kubectl delete events --field-selector involvedObject.name=ipaddressclaim-ipv4-vrf-apply-update -n $NAMESPACE
