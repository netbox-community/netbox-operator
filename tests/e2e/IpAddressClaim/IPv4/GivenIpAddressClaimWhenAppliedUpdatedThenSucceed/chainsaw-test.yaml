apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: prefixclaim-ipv4-apply-exhausted
spec:
  steps:
    - name: Install CR 1
      description: Apply IpAddressClaim CR 1
      try:
        - apply:
            file: netbox_v1_ipaddressclaim_1.yaml
        - assert:
            resource:
              apiVersion: netbox.dev/v1
              kind: IpAddressClaim
              metadata:
                name: ipaddressclaim-ipv4-apply-prefixexhausted-1
              spec:
                comments: your comments
                description: some description
                parentPrefix: 3.0.10.0/30
                preserveInNetbox: false
                tenant: MY_TENANT
              status:
                (conditions[?type == 'Ready']):
                  - status: 'True'
                ipAddress: 3.0.10.1/32
                ipAddressDotDecimal: 3.0.10.1
                ipAddressName: ipaddressclaim-ipv4-apply-prefixexhausted-1
        - assert:
            resource:
              apiVersion: netbox.dev/v1
              kind: IpAddress
              metadata:
                name: ipaddressclaim-ipv4-apply-prefixexhausted-1
                ownerReferences:
                  - apiVersion: netbox.dev/v1
                    blockOwnerDeletion: true
                    controller: true
                    kind: IpAddressClaim
                    name: ipaddressclaim-ipv4-apply-prefixexhausted-1
              spec:
                comments: your comments
                customFields:
                  netboxOperatorRestorationHash: c35345ed7de1a17d565670534e478df8e3e2d77a
                description: some description
                ipAddress: 3.0.10.1/32
                tenant: MY_TENANT
              status:
                (conditions[?type == 'Ready']):
                  - status: 'True'
    - name: Install CR 2
      description: Apply IpAddressClaim CR 2
      try:
        - apply:
            file: netbox_v1_ipaddressclaim_2.yaml
        - assert:
            resource:
              apiVersion: netbox.dev/v1
              kind: IpAddressClaim
              metadata:
                name: ipaddressclaim-ipv4-apply-prefixexhausted-2
              spec:
                comments: your comments
                description: some description
                parentPrefix: 3.0.10.0/30
                preserveInNetbox: false
                tenant: MY_TENANT
              status:
                (conditions[?type == 'Ready']):
                  - status: 'True'
                ipAddress: 3.0.10.2/32
                ipAddressDotDecimal: 3.0.10.2
                ipAddressName: ipaddressclaim-ipv4-apply-prefixexhausted-2
        - assert:
            resource:
              apiVersion: netbox.dev/v1
              kind: IpAddress
              metadata:
                name: ipaddressclaim-ipv4-apply-prefixexhausted-2
                ownerReferences:
                  - apiVersion: netbox.dev/v1
                    blockOwnerDeletion: true
                    controller: true
                    kind: IpAddressClaim
                    name: ipaddressclaim-ipv4-apply-prefixexhausted-2
              spec:
                comments: your comments
                customFields:
                  netboxOperatorRestorationHash: 9bdc55ac4b7543c00c787fbea1819233d9256b0c
                description: some description
                ipAddress: 3.0.10.2/32
                tenant: MY_TENANT
              status:
                (conditions[?type == 'Ready']):
                  - status: 'True'
    - name: Install CR 3
      description: Apply IpAddressClaim CR 3
      try:
        - apply:
            file: netbox_v1_ipaddressclaim_3.yaml
        - assert:
            resource:
              apiVersion: netbox.dev/v1
              kind: IpAddressClaim
              metadata:
                name: ipaddressclaim-ipv4-apply-prefixexhausted-3
              spec:
                comments: your comments
                description: some description
                parentPrefix: 3.0.10.0/30
                preserveInNetbox: false
                tenant: MY_TENANT
              status:
                (conditions[?type == 'IPAssigned']):  # TODO(jstudler): Change this to Ready, will need change in SetConditionAndCreateEvent to also update Ready condition
                  - status: 'False'
        - assert:
            resource:
              apiVersion: v1
              count: 1
              kind: Event
              type: Warning
              reason: IPAddressCRNotCreated
              source:
                component: ip-address-claim-controller
              message: Failed to fetch new IP from NetBox. parent prefix exhausted
              involvedObject:
                apiVersion: netbox.dev/v1
                kind: IpAddressClaim
                name: ipaddressclaim-ipv4-apply-prefixexhausted-3